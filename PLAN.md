了解しました。以下が、これまでの検討結果を反映した PLAN.md の改定版です。

````markdown
---

# 日数カウントアプリ PLAN（改定版）

## 0. 技術スタック

- フレームワーク: Hono v4
- ランタイム: Cloudflare Workers
- 言語: TypeScript
- スタイリング: Tailwind CSS（CDN を `<head>` で読み込み）
- ライブラリ: date-fns, date-fns-tz
- 描画: Hono の JSX（SSR）

---

## 1. アプリのゴール整理

**目的：**

- 「A日からB日まで、何日あるか」を**一瞬で・迷いなく**知れること。
- 旅行・締切・プロジェクト・記念日など、**現実のユースケースに即した表現**をしてあげること。
- 専用モード（旅行・締切など）を増やしすぎず、「境界の扱い」を明示することで理解しやすくする。

**ターゲット想定：**

- 旅行計画（◯泊◯日）
- 締切までの残り日数
- 記念日までのカウントダウン
- 工程管理の工数ざっくり見積もり

---

## 2. ユースケースと「数え方パターン」

アプリ内部では「開始日・終了日を含むかどうか」の2ビットで表現しつつ、  
ユーザーには以下 4 パターンだけをプリセットとして提示する。

### 2.1 数え方パターン（4種類）

| パターンID | ラベル例（UI）                          | 開始日含む | 終了日含む | 典型ユースケース                               |
|-----------|------------------------------------------|-----------|-----------|-----------------------------------------------|
| `both`    | 期間全体の日数（開始日と終了日を含める） | はい      | はい      | 単純な期間の長さ、イベント期間など           |
| `start`   | 旅行向け（チェックイン日を含める）      | はい      | いいえ    | 旅行の「◯泊◯日」（チェックアウト日は含めない）|
| `end`     | 締切までの残り日数（締切日を含める）    | いいえ    | はい      | 今日から締切まで何日か、残り日数カウントダウン |
| `none`    | 純粋な差分（日付のあいだの日数）        | いいえ    | いいえ    | 日付同士の差分だけを知りたい場合             |

※ カスタム（任意の組み合わせ指定）は v1 では持たず、**この 4 パターンだけに絞る**。

### 2.2 UI 上の見せ方

- 上記の表を、そのまま「選択 UI」として使うイメージ。
- 行全体をクリック可能にし、選択中の行は背景色や枠線で強調。
- 行の左端にラジオボタンを置き、  
  「以下から当てはまる数え方を選んでください」と短く説明する。

テキストとして「読み物」に見えがちな表だが、

- 行 hover 時にハイライト
- 行クリックで選択
- ラジオボタンも表示

といった工夫で「これは選べるリストである」と伝わるようにする。

---

## 3. 入出力仕様（URL / API）

### 3.1 画面（GET `/`）

#### クエリパラメータ

- `from`: 開始日（YYYY-MM-DD, 例: `2025-01-01`）
- `to`: 終了日（YYYY-MM-DD, 例: `2025-01-10`）
- `pattern`: 数え方パターン
  - 値：`both` / `start` / `end` / `none`
  - 省略時は `both`（開始・終了を含める）

例:

```text
/?
  from=2025-01-01&
  to=2025-01-10&
  pattern=start
````

#### SSR の挙動

* 上記クエリがあればサーバー側で計算し、結果を埋め込んだ HTML を返す。
* 未指定の場合は、デフォルト値で計算しない状態の画面を返す（空の結果 or プレースホルダ）。

### 3.2 API（GET `/api/diff`）

画面からの fetch 用および外部サービスからの利用を想定した API。

#### 入力クエリ

* `from`（必須）: YYYY-MM-DD
* `to`（必須）: YYYY-MM-DD
* `pattern`（任意）: `both` / `start` / `end` / `none`（省略時 `both`）

#### 正常時レスポンス（HTTP 200）

```json
{
  "from": "2025-01-01",
  "to": "2025-01-10",
  "pattern": "start",
  "includeStart": true,
  "includeEnd": false,
  "swapped": false,
  "days": 9,
  "detail": {
    "calendarDiff": 9,
    "weekendDays": 2,
    "weekdayDays": 7
  }
}
```

* `includeStart` / `includeEnd`: `pattern` から導出した内部フラグをそのまま返す。
* `swapped`: `from > to` だった場合に日付を自動入れ替えたら `true`。
* `days`: 指定パターンに基づく最終的な日数。
* `detail` は v1 では最低限（カレンダー差分など）にし、拡張余地を残す。

#### エラー時レスポンス（HTTP 400）

`from` / `to` が欠けている、フォーマット不正など。

```json
{
  "error": "INVALID_DATE",
  "message": "from と to には YYYY-MM-DD 形式の日付を指定してください。"
}
```

* バリデーションエラー系は 400 固定。
* サーバー内部エラーは 500 とし、`error: "INTERNAL_ERROR"` のように一応 JSON で返す。

---

## 4. UI 仕様

### 4.1 フォーム構成

* 日付入力

  * `from`: `<input type="date">`
  * `to`: `<input type="date">`
* 数え方パターン選択（表形式）

  * 前述の 4 行のパターン表
  * 行クリックで選択
* 実行ボタン

  * 「日数を計算する」

### 4.2 結果表示

* 基本表示：

  * 「◯日間」「残り◯日」「◯泊◯日」など、選択パターンに応じて文言を変える。
* 文言例：

| pattern | 文言の例                                                  |
| ------- | ----------------------------------------------------- |
| both    | `2025-01-01 から 2025-01-10 まで、合計 10 日間です。`             |
| start   | `2025-01-01 チェックイン、2025-01-10 チェックアウトの場合、9 泊 10 日です。` |
| end     | `締切日 2025-01-10 まで、残り 9 日です。`                         |
| none    | `2025-01-01 と 2025-01-10 のあいだの日数は 9 日です。`             |

* `pattern=start` の場合は、旅行ユースケースを想定した文言を優先。
* `pattern=end` の場合は、「締切」「残り◯日」を強調。

### 4.3 クイックボタン（v1 で最低限）

* 例：

  * 「今日を開始日にする」
  * 「今日を終了日にする」
* クリックで `from` or `to` に今日の日付（Asia/Tokyo）をセット。

※ 「今週の月曜日」「今月末」などは v2 以降に拡張。

---

## 5. 計算ロジック仕様

### 5.1 タイムゾーン

* v1 ではタイムゾーンを **`Asia/Tokyo` 固定** とする。
* 日付入力は `type="date"` で時刻を持たないため、基本的には tz の影響は少ない。
* 「今日」の判定など date-fns-tz を使う箇所も、`Asia/Tokyo` を明示的に指定。

### 5.2 日付差分と境界の扱い

1. `from` / `to` をパースして `Date` にする（`Asia/Tokyo` 基準）。

2. もし `from > to` なら、内部的に swap する。

   * `swapped = true` をフラグ立て。

3. カレンダー差分を求める：

   ```ts
   const calendarDiff = differenceInCalendarDays(toDate, fromDate); // 例: 2025-01-01〜10 → 9
   ```

4. `pattern` → `(includeStart, includeEnd)` の変換：

   | pattern | includeStart | includeEnd |
   | ------- | ------------ | ---------- |
   | both    | true         | true       |
   | start   | true         | false      |
   | end     | false        | true       |
   | none    | false        | false      |

5. 最終的な日数を計算：

   * 代表的な式の一例：

     ```ts
     let days = calendarDiff;
     if (includeStart) days += 1;
     if (includeEnd) days += 1;
     // ただし両端とも含まない none の場合は calendarDiff のままになるよう補正する
     if (includeStart && includeEnd) {
       // diff が 0 のときでも 1 日として扱うなど、テストで確認
     }
     ```

   * 実装時はテストケースに合わせて、`from == to` のときの挙動を明示的に決めておく：

     * `pattern=both` かつ同一日 → 1 日
     * `pattern=none` かつ同一日 → 0 日
     * など。

### 5.3 共通関数

* `calculateDiff(from: string, to: string, pattern: Pattern): Result` のような関数を `lib/dateDiff.ts` に定義。
* SSR（`GET /`）と API（`GET /api/diff`）、フロントの JS（必要なら）すべてこの関数を使う。

---

## 6. バリデーション / エラー仕様

### 6.1 フロント側

* `from` / `to` が未入力の場合、「日付を入力してください」と画面上でエラー表示。
* `from` / `to` のフォーマットが `YYYY-MM-DD` 以外の場合は、基本的にはブラウザの `type="date"` に任せる。

### 6.2 サーバー側（API）

* `from` / `to` が欠けている → 400 + `INVALID_DATE`。
* パース不可な日付 → 400 + `INVALID_DATE`。
* `pattern` が想定外の値 → 400 + `INVALID_PATTERN` としてエラー。

---

## 7. 非機能要件

* **パフォーマンス**

  * Hono + Cloudflare Workers で軽量レスポンス。
  * 1 リクエストあたりの計算は軽く、負荷は問題にならない想定。
* **プライバシー**

  * アプリとしては、独自に日付データをサーバー側に保存しない。
  * ただしインフラ（Cloudflare）が保持する最小限のアクセスログは除く。
* **UX**

  * JS 有効時：

    * 入力変更ごとに即座に再計算（デバウンスは必要であれば）。
    * URL クエリに状態を反映し、そのままシェア可能にする。
  * JS 無効時：

    * フォーム submit → SSR 再描画で結果表示。
    * パターン表も通常のラジオボタンとして機能するようにしておく。

---

## 8. まとめ

このアプリは機能自体は「日付差を出すだけ」だが、

* 4 種類の「数え方パターン」を明示し、
* 専用モードではなく「境界をどう含めるか」で統一し、
* パターン表をそのまま選択 UI として活用することで、
* 旅行・締切・単純な期間計算などのユースケースをわかりやすくカバーできる。

さらに、

* クイックボタン
* URLパラメータによるシェア
* SSR＋クライアント計算のサクサク体験

を丁寧に設計することで、
**「他のどの類似サービスよりも使いやすい日数カウンター」**を目指す。

---

```
```
